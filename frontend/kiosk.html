<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Staff Kiosk - Clock In/Out</title>

  <!--
    KIOSK SYSTEM OVERVIEW:
    ======================
    This is the main kiosk interface for staff clock in/out operations.

    AUTHENTICATION FLOW:
    1. Venue Login: Kiosk logs in using venue email + password (stored in venues table)
    2. Staff Selection: Staff member clicks their card from the grid
    3. PIN Entry: Staff enters 6-digit PIN (stored in users.kiosk_pin)
    4. Clock Operations: Clock in/out, start/end breaks

    KEY FEATURES:
    - Real-time status updates (polling every 5 seconds)
    - Offline support (actions queue in localStorage and sync when online)
    - Break tracking (accumulates break time, deducts from hours worked)
    - Automatic pay calculation (based on payday type and rates)
    - Visual status indicators (green=active, orange=on break, gray=inactive)

    CONNECTED BACKEND:
    - API Endpoints: /api/kiosk/* (see backend/routes/kiosk.js)
    - Database Tables: shifts, staff, users, venues, pay_rates, sync_log
    - JavaScript Logic: js/kiosk/index.js (main), js/kiosk/breaks.js (break tracking)

    For full documentation, see: KIOSK_DOCUMENTATION.md
  -->

  <!-- TailwindCSS: Utility-first CSS framework for styling -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Bootstrap Icons: Icon library for UI elements -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Luxon: DateTime library for timezone conversions -->
  <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3b82f6',
            secondary: '#1e40af',
          }
        }
      }
    }
  </script>
  <style>
    /*
      CUSTOM STYLES
      =============
      This section defines visual styles for the kiosk interface.
      To customize appearance, modify colors, animations, or layouts here.
    */

    body {
      /* Gradient background for the entire page */
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    }

    /* ============================
       STAFF CARD ANIMATIONS
       ============================
       Staff cards change appearance based on shift state:
       - status-active: Green glowing border (staff is clocked in)
       - status-break: Orange glowing border (staff is on break)
       - status-idle: Gray border (staff is not clocked in)
    */
    .staff-card {
      position: relative;
      transition: all 0.3s ease;
    }

    /* ACTIVE STATE: Green gradient border with pulsing glow */
    .staff-card.status-active {
      border: 3px solid transparent;
      background-image: linear-gradient(white, white),
        linear-gradient(135deg, #4ade80, #16a34a, #15803d);
      background-origin: border-box;
      background-clip: padding-box, border-box;
      box-shadow: 0 0 20px rgba(22, 163, 74, 0.4);
      animation: pulseGreen 2s ease-in-out infinite;
      transform: scale(1.02);
    }

    /* ON BREAK STATE: Orange gradient border with pulsing glow */
    .staff-card.status-break {
      border: 3px solid transparent;
      background-image: linear-gradient(white, white),
        linear-gradient(135deg, #fb923c, #f97316, #ea580c);
      background-origin: border-box;
      background-clip: padding-box, border-box;
      box-shadow: 0 0 20px rgba(249, 115, 22, 0.4);
      animation: pulseOrange 3s ease-in-out infinite;
      transform: scale(1.02);
    }

    /* IDLE STATE: Simple gray border (not clocked in) */
    .staff-card.status-idle {
      border: 2px solid #d1d5db;
    }

    /* ============================
       PULSE ANIMATIONS
       ============================
       Creates glowing effect for active and on-break states.
       To adjust speed: Change animation duration (2s = 2 seconds)
       To adjust intensity: Change box-shadow opacity values
    */
    @keyframes pulseGreen {
      0%, 100% {
        box-shadow: 0 0 20px rgba(22, 163, 74, 0.4);
      }
      50% {
        box-shadow: 0 0 30px rgba(22, 163, 74, 0.7);
      }
    }

    @keyframes pulseOrange {
      0%, 100% {
        box-shadow: 0 0 20px rgba(249, 115, 22, 0.4);
      }
      50% {
        box-shadow: 0 0 30px rgba(249, 115, 22, 0.7);
      }
    }

    /* Status Badge */
    .status-badge {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      border: 2px solid white;
      z-index: 10;
    }

    .status-badge.active {
      background-color: #16a34a;
    }

    .status-badge.break {
      background-color: #f97316;
    }

    .status-badge.idle {
      background-color: #9ca3af;
    }

    /* Time Overlay */
    .time-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 6px 8px;
      font-size: 0.75rem;
      text-align: center;
      border-radius: 0 0 0.75rem 0.75rem;
    }

    /* Idle Screen Overlay */
    .idle-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      cursor: pointer;
    }

    /* Step 5: System Status Indicator */
    .status-indicator {
      position: fixed;
      bottom: 10px;
      right: 10px;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      color: white;
      background: #198754;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .status-indicator::before {
      content: '';
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: currentColor;
      animation: pulse 2s ease-in-out infinite;
    }

    .status-indicator.offline {
      background: #dc3545;
    }

    .status-indicator.offline::before {
      animation: none;
    }

    .status-indicator.syncing {
      background: #ffc107;
      color: #000;
    }

    .status-indicator.syncing::before {
      animation: spin 1s linear infinite;
    }

    /* Step 6: Paused state */
    .status-indicator.paused {
      background: #6c757d;
      color: #fff;
    }

    .status-indicator.paused::before {
      animation: none;
      opacity: 0.6;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="min-h-screen">
  <!--
    ========================================
    HEADER SECTION
    ========================================
    Displays venue name, live clock (in venue timezone), and logout button.
    Updated by: js/kiosk/index.js after venue login
  -->
  <nav class="bg-slate-800 shadow-lg mb-6">
    <div class="container mx-auto px-4">
      <div class="flex items-center justify-between h-16">
        <a class="flex items-center text-white" href="#">
          <i class="bi bi-people-fill text-3xl mr-3"></i>
          <span class="text-xl font-bold">Staff Kiosk</span>
        </a>
        <div class="flex items-center gap-4">
          <!-- Live clock showing venue's local time (uses Luxon for timezone conversion) -->
          <div id="venueClock" class="text-white text-lg font-semibold"></div>

          <!-- Venue name from kioskContext (set after login) -->
          <span class="text-white" id="venueName">Loading...</span>

          <!-- Logout button (hidden until venue is logged in) -->
          <button class="hidden px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-all duration-200" id="logoutBtn">
            <i class="bi bi-box-arrow-right mr-2"></i>Logout
          </button>
        </div>
      </div>
    </div>
  </nav>

  <!--
    ========================================
    OFFLINE BANNER
    ========================================
    Appears when backend health check fails (hidden by default).
    Actions are queued in localStorage and synced when backend returns.
    Controlled by: js/kiosk/index.js health check logic
  -->
  <div id="offlineBanner" style="display:none; background:#dc2626; color:#fff; padding:12px; text-align:center; font-weight:600; box-shadow: 0 2px 8px rgba(0,0,0,0.15);">
    <i class="bi bi-exclamation-triangle-fill mr-2"></i>⚠️ Backend Unavailable — Actions will be queued and synced when backend is restored
  </div>

  <div class="container mx-auto px-4 max-w-7xl">
    <!--
      ========================================
      KIOSK LOGIN FORM
      ========================================
      Step 1: Venue authentication
      Credentials: venues.contact_email + venues.kiosk_password
      API Endpoint: POST /api/kiosk/login
      Success: Hides this form, shows kioskPanel
    -->
    <div id="kioskLogin" class="max-w-md mx-auto">
      <div class="bg-white rounded-2xl shadow-2xl p-8">
        <h3 class="text-3xl font-bold text-center mb-6 text-slate-800">
          <i class="bi bi-door-open mr-2"></i>Kiosk Login
        </h3>
        <div class="mb-4">
          <input
            id="kioskUsername"
            placeholder="Venue Email"
            class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 transition-all"
            autocomplete="username"
            type="email">
        </div>
        <div class="mb-6">
          <input
            id="kioskPassword"
            placeholder="Kiosk Password"
            type="password"
            class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 transition-all"
            autocomplete="current-password">
        </div>
        <button class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-xl transition-all duration-200 transform hover:scale-105" id="kioskLoginButton">
          <i class="bi bi-unlock mr-2"></i>Login
        </button>
        <div id="kioskLoginError" class="mt-4"></div>
      </div>
    </div>

    <!--
      ========================================
      KIOSK PANEL (Main Interface)
      ========================================
      Shown after successful venue login (hidden by default).
      Contains staff grid, PIN modal, and clock controls.
    -->
    <div id="kioskPanel" class="hidden">
      <!--
        STAFF GRID
        ==========
        Dynamically populated with staff cards from API: GET /api/kiosk/staff
        Each card shows: staff name, code, status badge, time overlay
        Updated every 5 seconds via status polling
        Grid layout: 2 cols (mobile) → 3 (tablet) → 4 (desktop) → 5 (wide)
      -->
      <div id="staffGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 mb-4"></div>

      <!--
        STATUS LEGEND
        =============
        Visual guide for staff card colors:
        - Green: Staff is clocked in (ACTIVE state)
        - Orange: Staff is on break (ON_BREAK state)
        - Gray: Staff is not clocked in (NONE state)
      -->
      <div id="statusLegend" class="bg-white rounded-xl shadow-lg p-4 mb-6 flex items-center justify-center gap-6 text-sm">
        <div class="flex items-center gap-2">
          <span class="inline-block w-3 h-3 rounded-full bg-green-600"></span>
          <span class="text-gray-700">Active</span>
        </div>
        <div class="flex items-center gap-2">
          <span class="inline-block w-3 h-3 rounded-full bg-orange-500"></span>
          <span class="text-gray-700">On Break</span>
        </div>
        <div class="flex items-center gap-2">
          <span class="inline-block w-3 h-3 rounded-full bg-gray-400"></span>
          <span class="text-gray-700">Inactive</span>
        </div>
      </div>

      <!--
        ========================================
        PIN ENTRY MODAL
        ========================================
        Step 2: Staff authentication
        Appears when staff card is clicked
        Validates: users.kiosk_pin (6-digit numeric)
        API Endpoint: POST /api/kiosk/validate-pin
        Success: Hides modal, shows clockSection
      -->
      <div class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" id="pinModal">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4">
          <h3 class="text-2xl font-bold text-center mb-4 text-slate-800">
            <i class="bi bi-shield-lock mr-2"></i>Enter Your PIN
          </h3>
          <p class="text-center text-gray-600 mb-6" id="pinStaffName">Staff Member</p>

          <!-- PIN Input -->
          <div class="mb-6">
            <input
              type="password"
              id="pinInput"
              maxlength="6"
              pattern="[0-9]{6}"
              placeholder="Enter 6-digit PIN"
              class="w-full px-6 py-4 text-center text-3xl font-mono border-4 border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 transition-all tracking-widest"
              autocomplete="off"
              inputmode="numeric">
            <div class="text-sm text-gray-500 text-center mt-2">6-digit numeric PIN</div>
          </div>

          <!-- Error Message -->
          <div id="pinError" class="hidden mb-4 px-4 py-3 bg-red-100 text-red-800 rounded-xl text-center font-semibold"></div>

          <!-- Buttons -->
          <div class="grid grid-cols-2 gap-4">
            <button id="pinCancelBtn" class="px-6 py-3 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold rounded-xl transition-all">
              <i class="bi bi-x-circle mr-2"></i>Cancel
            </button>
            <button id="pinSubmitBtn" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl transition-all">
              <i class="bi bi-check-circle mr-2"></i>Submit
            </button>
          </div>
        </div>
      </div>

      <!--
        ========================================
        CLOCK SECTION
        ========================================
        Step 3: Clock operations interface
        Shown after successful PIN validation (hidden by default)
        Contains: status display, clock in/out buttons, break buttons
        Button states managed by: js/kiosk/index.js based on current shift_state
      -->
      <div class="hidden bg-white rounded-2xl shadow-2xl overflow-hidden max-w-2xl mx-auto" id="clockSection">
        <div class="bg-blue-600 text-white px-6 py-4 flex items-center justify-between">
          <h5 class="text-xl font-bold flex items-center">
            <i class="bi bi-clock mr-2"></i>
            <span id="selectedStaffName">Staff Member</span>
          </h5>
          <button class="px-4 py-2 bg-white/20 hover:bg-white/30 rounded-lg transition-all" id="backToStaffListBtn">
            <i class="bi bi-arrow-left mr-2"></i> Back
          </button>
        </div>
        <div class="p-6">
          <!-- Current shift status display -->
          <div class="mb-6">
            <div id="statusDisplay" class="px-6 py-4 bg-blue-100 text-blue-800 rounded-xl text-center font-semibold">
              Loading status...
            </div>
          </div>

          <!--
            CLOCK IN/OUT BUTTONS
            ====================
            Clock In: POST /api/kiosk/shift/:staff_code/clockin
            Clock Out: POST /api/kiosk/shift/:id/clockout
            Button states:
            - shift_state = NONE: Clock In enabled, Clock Out disabled
            - shift_state = ACTIVE: Clock In disabled, Clock Out enabled
            - shift_state = ON_BREAK: Both disabled (must end break first)
          -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <button id="clockInBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-xl transition-all transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">
              <i class="bi bi-play-circle mr-2"></i> Clock In
            </button>
            <button id="clockOutBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-4 rounded-xl transition-all transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">
              <i class="bi bi-stop-circle mr-2"></i> Clock Out
            </button>
          </div>

          <!--
            BREAK BUTTONS
            =============
            Start Break: POST /api/kiosk/shift/:id/breakin
            End Break: POST /api/kiosk/shift/:id/breakout
            Button states:
            - shift_state = ACTIVE: Start Break enabled, End Break disabled
            - shift_state = ON_BREAK: Start Break disabled, End Break enabled
            - shift_state = NONE: Both disabled (must clock in first)
            Break time accumulates and is deducted from hours_worked on clock out
          -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
            <button id="breakInBtn" class="d-none bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-4 rounded-xl transition-all transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">
              <i class="bi bi-pause-circle mr-2"></i> Start Break
            </button>
            <button id="breakOutBtn" class="d-none bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl transition-all transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">
              <i class="bi bi-play-fill mr-2"></i> End Break
            </button>
          </div>

          <!-- Success/error messages -->
          <div id="message" class="hidden mt-4 px-6 py-4 rounded-xl"></div>
        </div>
      </div>
    </div>
  </div>

  <!--
    ========================================
    IDLE SCREEN OVERLAY
    ========================================
    Appears after period of inactivity (configurable)
    Touch anywhere to dismiss and wake screen
    Managed by: js/kiosk/index.js idle timer
  -->
  <div id="idleOverlay" class="idle-overlay hidden">
    <div class="text-center text-white">
      <i class="bi bi-moon-stars text-6xl mb-4"></i>
      <h2 class="text-3xl font-bold mb-2">Screen Dimmed</h2>
      <p class="text-xl">Touch anywhere to wake</p>
    </div>
  </div>

  <!--
    ========================================
    SYSTEM STATUS INDICATOR
    ========================================
    Shows backend connectivity status (bottom-right corner)
    States:
    - Online (green): Backend healthy, normal operation
    - Offline (red): Backend unavailable, actions queued locally
    - Syncing (yellow): Uploading queued actions to backend
    Updated by: js/kiosk/index.js health check (every 10 seconds)
  -->
  <div id="systemStatus" class="status-indicator">Online</div>

  <!--
    ========================================
    JAVASCRIPT ENTRY POINT
    ========================================
    Main kiosk logic: js/kiosk/index.js (ES6 module)
    Handles:
    - Venue login
    - PIN validation
    - Clock operations
    - Status polling
    - Offline sync
    - Health checks
    - UI updates
  -->
  <script type="module" src="js/kiosk/index.js"></script>
</body>
</html>
